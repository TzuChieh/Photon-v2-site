\doxysection{TSPSCExecutor.\+h}
\hypertarget{_t_s_p_s_c_executor_8h_source}{}\label{_t_s_p_s_c_executor_8h_source}\index{Source/Utility/Concurrent/TSPSCExecutor.h@{Source/Utility/Concurrent/TSPSCExecutor.h}}
\mbox{\hyperlink{_t_s_p_s_c_executor_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_t_blockable_atomic_quasi_queue_8h}{Utility/Concurrent/TBlockableAtomicQuasiQueue.h}}"{}}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_initially_paused_thread_8h}{Utility/Concurrent/InitiallyPausedThread.h}}"{}}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_t_function_8h}{Utility/TFunction.h}}"{}}}
\DoxyCodeLine{00006\ }
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ <Common/primitive\_type.h>}}
\DoxyCodeLine{00008\ }
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ <type\_traits>}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ <thread>}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ <utility>}}
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#include\ <atomic>}}
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#include\ <functional>}}
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ <variant>}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespaceph}{ph}}}
\DoxyCodeLine{00017\ \{}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00026\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Work>}
\DoxyCodeLine{00027\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor}{TSPSCExecutor}}\ final}
\DoxyCodeLine{00028\ \{}
\DoxyCodeLine{00029\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00032\ \ \ \ \ \textcolor{keyword}{inline}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_a9f6b5ce0addb84a3de6294984c9612a3}{TSPSCExecutor}}()}
\DoxyCodeLine{00033\ \ \ \ \ \ \ \ \ :\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor}{TSPSCExecutor}}(nullptr)}
\DoxyCodeLine{00034\ \ \ \ \ \{\}}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00038\ \ \ \ \ \textcolor{keyword}{inline}\ \textcolor{keyword}{explicit}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_a6dfdf73fc1054ad47c06b9370768b58f}{TSPSCExecutor}}(std::function<\textcolor{keywordtype}{void}(\textcolor{keyword}{const}\ Work\&\ work)>\ workProcessor)}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ :\ m\_thread\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ()}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ ,\ m\_workloadQueue\ \ \ \ \ \ \ \ \ ()}
\DoxyCodeLine{00041\ \ \ \ \ \ \ \ \ ,\ m\_isTerminationRequested()}
\DoxyCodeLine{00042\ \ \ \ \ \ \ \ \ ,\ m\_isTerminated\ \ \ \ \ \ \ \ \ \ ()}
\DoxyCodeLine{00043\ \ \ \ \ \ \ \ \ ,\ m\_producerThreadId\ \ \ \ \ \ ()}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ ,\ m\_workProcessor\ \ \ \ \ \ \ \ \ (\mbox{\hyperlink{namespacestd}{std}}::move(workProcessor))}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ ,\ m\_onConsumerStart\ \ \ \ \ \ \ ()}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ ,\ m\_onConsumerTerminate\ \ \ ()}
\DoxyCodeLine{00047\ \ \ \ \ \{}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ m\_thread\ =\ \mbox{\hyperlink{classph_1_1_initially_paused_thread}{InitiallyPausedThread}}(}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \ \ \ \ [\textcolor{keyword}{this}]()}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ asyncExecute();}
\DoxyCodeLine{00052\ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00053\ \ \ \ \ \}}
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00057\ \ \ \ \ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_a98a11651bfe5596cb1acb4d5125c45fb}{\string~TSPSCExecutor}}();}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00064\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_aff408fe833f82bb136083d0e62ff8592}{setWorkProcessor}}(std::function<\textcolor{keywordtype}{void}(\textcolor{keyword}{const}\ Work\&\ work)>\ workProcessor);}
\DoxyCodeLine{00065\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_a3352d75b6451c17a0093f81900597d3f}{setOnConsumerStart}}(std::function<\textcolor{keywordtype}{void}(\textcolor{keywordtype}{void})>\ onConsumerStart);}
\DoxyCodeLine{00066\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_ae1ccd9b88d8123367b8a194ee2a0d79d}{setOnConsumerTerminate}}(std::function<\textcolor{keywordtype}{void}(\textcolor{keywordtype}{void})>\ onConsumerTerminate);}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00074\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_a0d4416821710b9c3c01b9798376a9f4e}{start}}();}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00082\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ DeducedWork>}
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_a348023aebd44b96af2d54e6aacda79a0}{addWork}}(DeducedWork\&\&\ work);}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \ \ \ \ \textcolor{comment}{//\ TODO:\ bulk\ work\ addition}}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00091\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_a75b1bd75567ccb5adcd30bdd592b42ce}{waitAllWorks}}();}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00099\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_a52bee5c6bbc09397af7f73ef55969c93}{requestTermination}}();}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_ace6ac9244a6753e4a2da159fabd10d8d}{waitForTermination}}();}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00112\ \ \ \ \ std::thread::id\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_a7dd7b547217281c83d117359584375b1}{getId}}()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00117\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_ac550b3718b38d56f5684e1ea546ee7d2}{hasStarted}}()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00118\ }
\DoxyCodeLine{00119\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00123\ \ \ \ \ \textcolor{keywordtype}{void}\ asyncExecute();}
\DoxyCodeLine{00124\ }
\DoxyCodeLine{00128\ \ \ \ \ \textcolor{keywordtype}{void}\ asyncProcessWorks();}
\DoxyCodeLine{00129\ }
\DoxyCodeLine{00133\ \ \ \ \ \textcolor{keywordtype}{bool}\ isConsumerThread()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00134\ }
\DoxyCodeLine{00138\ \ \ \ \ \textcolor{keywordtype}{bool}\ isProducerThread()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00142\ \ \ \ \ \textcolor{keywordtype}{void}\ terminate();}
\DoxyCodeLine{00143\ }
\DoxyCodeLine{00144\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00145\ \ \ \ \ \textcolor{comment}{//\ Callable\ type\ for\ internal\ usages.\ Warpping\ with\ a\ custom\ private\ type\ so\ we\ cannot\ mix\ }}
\DoxyCodeLine{00146\ \ \ \ \ \textcolor{comment}{//\ it\ with\ user\ types}}
\DoxyCodeLine{00147\ \ \ \ \ \textcolor{keyword}{struct\ }CustomCallable}
\DoxyCodeLine{00148\ \ \ \ \ \{}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classph_1_1function__detail_1_1_t_function}{TFunction}}<void(\textcolor{keywordtype}{void}),\ 0>\ callable;}
\DoxyCodeLine{00150\ \ \ \ \ \};}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00152\ \ \ \ \ \textcolor{comment}{//\ Possibly\ store\ both\ user-\/specified\ work\ and\ custom\ callables\ for\ internal\ usages}}
\DoxyCodeLine{00153\ \ \ \ \ \textcolor{keyword}{using\ }Workload\ =\ std::variant<}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ std::monostate,}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ Work,}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ CustomCallable>;}
\DoxyCodeLine{00157\ }
\DoxyCodeLine{00158\ \ \ \ \ \textcolor{comment}{//\ NOTE:\ moodycamel\ has\ faster\ SPSC\ queue,\ consider\ using\ it}}
\DoxyCodeLine{00159\ }
\DoxyCodeLine{00160\ \ \ \ \ InitiallyPausedThread\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_thread;}
\DoxyCodeLine{00161\ \ \ \ \ TBlockableAtomicQuasiQueue<Workload>\ \ m\_workloadQueue;}
\DoxyCodeLine{00162\ \ \ \ \ std::atomic\_flag\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_isTerminationRequested;}
\DoxyCodeLine{00163\ \ \ \ \ std::atomic\_flag\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_isTerminated;}
\DoxyCodeLine{00164\ \ \ \ \ std::thread::id\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_producerThreadId;}
\DoxyCodeLine{00165\ }
\DoxyCodeLine{00166\ \ \ \ \ \textcolor{comment}{//\ Worker-\/thread\ only\ fields}}
\DoxyCodeLine{00167\ \ \ \ \ std::function<void(\textcolor{keyword}{const}\ Work\&\ work)>\ m\_workProcessor;}
\DoxyCodeLine{00168\ \ \ \ \ std::function<void(\textcolor{keywordtype}{void})>\ \ \ \ \ \ \ \ \ \ \ \ \ m\_onConsumerStart;}
\DoxyCodeLine{00169\ \ \ \ \ std::function<void(\textcolor{keywordtype}{void})>\ \ \ \ \ \ \ \ \ \ \ \ \ m\_onConsumerTerminate;}
\DoxyCodeLine{00170\ \};}
\DoxyCodeLine{00171\ }
\DoxyCodeLine{00172\ \}\textcolor{comment}{//\ end\ namespace\ ph}}
\DoxyCodeLine{00173\ }
\DoxyCodeLine{00174\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_t_s_p_s_c_executor_8ipp}{Utility/Concurrent/TSPSCExecutor.ipp}}"{}}}

\end{DoxyCode}
