\doxysection{TEvent\+Dispatcher.\+h}
\hypertarget{_t_event_dispatcher_8h_source}{}\label{_t_event_dispatcher_8h_source}\index{Source/EditorCore/TEventDispatcher.h@{Source/EditorCore/TEventDispatcher.h}}
\mbox{\hyperlink{_t_event_dispatcher_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_event_8h}{EditorCore/Event/Event.h}}"{}}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_t_event_listener_8h}{EditorCore/TEventListener.h}}"{}}}
\DoxyCodeLine{00005\ }
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ <Utility/TFunction.h>}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ <Common/primitive\_type.h>}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ <Common/assertion.h>}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ <Common/exceptions.h>}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ <Utility/TUniquePtrVector.h>}}
\DoxyCodeLine{00011\ }
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#include\ <limits>}}
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#include\ <type\_traits>}}
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ <utility>}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ <cstddef>}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ <vector>}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespaceph_1_1editor}{ph::editor}}}
\DoxyCodeLine{00019\ \{}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ EventType>}
\DoxyCodeLine{00022\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher}{TEventDispatcher}}\ final}
\DoxyCodeLine{00023\ \{}
\DoxyCodeLine{00024\ \ \ \ \ \textcolor{keyword}{static\_assert}(std::is\_base\_of\_v<Event,\ EventType>);}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00026\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00027\ \ \ \ \ \textcolor{keyword}{using\ }\mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_a51fa7114b6d70184bea98884d0aa5afe}{Listener}}\ =\ \mbox{\hyperlink{namespaceph_1_1editor_a1a0561f7bff58f14e0b7d802a457cb66}{TEventListener<EventType>}};}
\DoxyCodeLine{00028\ }
\DoxyCodeLine{00029\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00030\ \ \ \ \ \mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_a51fa7114b6d70184bea98884d0aa5afe}{Listener}}*\ \mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_ae45102a96ca458b68a8c1273e871e8a3}{addListener}}(\mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_a51fa7114b6d70184bea98884d0aa5afe}{Listener}}\ listener);}
\DoxyCodeLine{00031\ }
\DoxyCodeLine{00041\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_a0720d4af9e3cacb6a4c97254be391ef8}{removeListener}}(\mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_a51fa7114b6d70184bea98884d0aa5afe}{Listener}}*\ listener);}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00047\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_aae5b7cba46100967365af45d935b23da}{removeListenerImmediately}}(\mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_a51fa7114b6d70184bea98884d0aa5afe}{Listener}}*\ listener);}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00055\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ DispatchFunc>}
\DoxyCodeLine{00056\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_aeec3e0acebcc6bc1821536187f763c1a}{dispatch}}(\textcolor{keyword}{const}\ EventType\&\ e,\ DispatchFunc\ dispatchFunc);}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00058\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_a1199918cdc065ab10414df8fb54d7794}{dispatch}}(\textcolor{keyword}{const}\ EventType\&\ e);}
\DoxyCodeLine{00059\ }
\DoxyCodeLine{00060\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00061\ \ \ \ \ TUniquePtrVector<Listener>\ m\_listeners;}
\DoxyCodeLine{00062\ \ \ \ \ std::vector<Listener*>\ m\_listenersToRemove;}
\DoxyCodeLine{00063\ \ \ \ \ \textcolor{keywordtype}{bool}\ m\_isDispatching\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00064\ \};}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00066\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ EventType>}
\DoxyCodeLine{00067\ \textcolor{keyword}{inline}\ \textcolor{keyword}{auto}\ \mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_ae45102a96ca458b68a8c1273e871e8a3}{TEventDispatcher<EventType>::addListener}}(\mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_a51fa7114b6d70184bea98884d0aa5afe}{Listener}}\ listener)}
\DoxyCodeLine{00068\ \ \ \ \ -\/>\ \mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_a51fa7114b6d70184bea98884d0aa5afe}{Listener}}*}
\DoxyCodeLine{00069\ \{}
\DoxyCodeLine{00070\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_listeners.add(std::make\_unique<Listener>(std::move(listener)));}
\DoxyCodeLine{00071\ \}}
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00073\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ EventType>}
\DoxyCodeLine{00074\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_a0720d4af9e3cacb6a4c97254be391ef8}{TEventDispatcher<EventType>::removeListener}}(\mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_a51fa7114b6d70184bea98884d0aa5afe}{Listener}}*\ \textcolor{keyword}{const}\ listener)}
\DoxyCodeLine{00075\ \{}
\DoxyCodeLine{00076\ \ \ \ \ \textcolor{keywordflow}{if}(!listener)}
\DoxyCodeLine{00077\ \ \ \ \ \{}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00079\ \ \ \ \ \}}
\DoxyCodeLine{00080\ }
\DoxyCodeLine{00081\ \ \ \ \ \textcolor{comment}{//\ Add\ to\ the\ pending-\/to-\/remove\ queue,\ will\ actually\ be\ removed\ in\ \`{}dispatch()`}}
\DoxyCodeLine{00082\ \ \ \ \ m\_listenersToRemove.push\_back(listener);}
\DoxyCodeLine{00083\ \}}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ EventType>}
\DoxyCodeLine{00086\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_aae5b7cba46100967365af45d935b23da}{TEventDispatcher<EventType>::removeListenerImmediately}}(\mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_a51fa7114b6d70184bea98884d0aa5afe}{Listener}}*\ \textcolor{keyword}{const}\ listener)}
\DoxyCodeLine{00087\ \{}
\DoxyCodeLine{00088\ \ \ \ \ \textcolor{keywordflow}{if}(!listener)}
\DoxyCodeLine{00089\ \ \ \ \ \{}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00091\ \ \ \ \ \}}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00093\ \ \ \ \ \textcolor{keywordflow}{if}(m\_isDispatching)}
\DoxyCodeLine{00094\ \ \ \ \ \{}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ IllegalOperationException(}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Cannot\ remove\ listeners\ during\ dispatch.\ Use\ removeListener(1)\ instead."{}});}
\DoxyCodeLine{00097\ \ \ \ \ \}}
\DoxyCodeLine{00098\ }
\DoxyCodeLine{00099\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\ removedListener\ =\ m\_listeners.remove(listener);}
\DoxyCodeLine{00100\ \ \ \ \ PH\_ASSERT(removedListener\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00101\ \}}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00103\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ EventType>}
\DoxyCodeLine{00104\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ DispatchFunc>}
\DoxyCodeLine{00105\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_aeec3e0acebcc6bc1821536187f763c1a}{TEventDispatcher<EventType>::dispatch}}(\textcolor{keyword}{const}\ EventType\&\ e,\ DispatchFunc\ dispatchFunc)}
\DoxyCodeLine{00106\ \{}
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{keyword}{static\_assert}(std::is\_invocable\_v<DispatchFunc,\ EventType,\ Listener>,}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}DispatchFunc\ must\ take\ (EventType,\ Listener)."{}});}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00110\ \ \ \ \ \textcolor{comment}{//\ Only\ actually\ remove\ listeners\ before\ dispatch-\/-\/so\ other\ listeners\ can\ be\ kept\ valid}}
\DoxyCodeLine{00111\ \ \ \ \ \textcolor{comment}{//\ during\ dispatch.\ Also,\ removal\ is\ done\ before\ dispatch\ so\ calls\ to\ \`{}removeListener()`\ }}
\DoxyCodeLine{00112\ \ \ \ \ \textcolor{comment}{//\ are\ respected.\ Calling\ \`{}removeListener()`\ during\ dispatch\ will\ take\ effect\ in\ the\ next\ dispatch.}}
\DoxyCodeLine{00113\ \ \ \ \ \textcolor{keywordflow}{for}(\mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_a51fa7114b6d70184bea98884d0aa5afe}{Listener}}*\ listener\ :\ m\_listenersToRemove)}
\DoxyCodeLine{00114\ \ \ \ \ \{}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ removeListenerImmediately(listener);}
\DoxyCodeLine{00116\ \ \ \ \ \}}
\DoxyCodeLine{00117\ \ \ \ \ m\_listenersToRemove.clear();}
\DoxyCodeLine{00118\ }
\DoxyCodeLine{00119\ \ \ \ \ \textcolor{comment}{//\ Iterate\ through\ all\ listeners\ and\ invoke\ the\ dispatch\ function\ on\ each\ of\ them.\ The\ code\ is}}
\DoxyCodeLine{00120\ \ \ \ \ \textcolor{comment}{//\ aware\ of\ that\ listeners\ might\ get\ added/removed\ (calling\ \`{}addListener()`\ and\ \`{}removeListener()`)}}
\DoxyCodeLine{00121\ \ \ \ \ \textcolor{comment}{//\ in\ the\ call\ to\ dispatch\ function.\ Listeners\ added/removed\ in\ the\ dispatch\ function\ will\ only}}
\DoxyCodeLine{00122\ \ \ \ \ \textcolor{comment}{//\ participate\ in\ the\ next\ call\ to\ \`{}dispatch()`.}}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00124\ \ \ \ \ \textcolor{comment}{//\ Record\ current\ count\ so\ newly\ added\ listeners\ will\ not\ get\ involved\ this\ time}}
\DoxyCodeLine{00125\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\ numListeners\ =\ m\_listeners.size();}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00127\ \ \ \ \ \textcolor{comment}{//\ Guard\ against\ nested\ dispatch\ call}}
\DoxyCodeLine{00128\ \ \ \ \ PH\_ASSERT(!m\_isDispatching);}
\DoxyCodeLine{00129\ }
\DoxyCodeLine{00130\ \ \ \ \ m\_isDispatching\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00131\ \ \ \ \ \textcolor{keywordflow}{for}(std::size\_t\ listenerIdx\ =\ 0;\ listenerIdx\ <\ numListeners;\ ++listenerIdx)}
\DoxyCodeLine{00132\ \ \ \ \ \{}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ dispatchFunc(e,\ *m\_listeners[listenerIdx]);}
\DoxyCodeLine{00134\ \ \ \ \ \}}
\DoxyCodeLine{00135\ \ \ \ \ m\_isDispatching\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00136\ \}}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ EventType>}
\DoxyCodeLine{00139\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_aeec3e0acebcc6bc1821536187f763c1a}{TEventDispatcher<EventType>::dispatch}}(\textcolor{keyword}{const}\ EventType\&\ e)}
\DoxyCodeLine{00140\ \{}
\DoxyCodeLine{00141\ \ \ \ \ dispatch(}
\DoxyCodeLine{00142\ \ \ \ \ \ \ \ \ e,\ }
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ [](\textcolor{keyword}{const}\ EventType\&\ e,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classph_1_1editor_1_1_t_event_dispatcher_a51fa7114b6d70184bea98884d0aa5afe}{Listener}}\&\ listener)}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \ \ \ \ listener(e);}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00147\ \}}
\DoxyCodeLine{00148\ }
\DoxyCodeLine{00149\ \}\textcolor{comment}{//\ end\ namespace\ ph}}

\end{DoxyCode}
