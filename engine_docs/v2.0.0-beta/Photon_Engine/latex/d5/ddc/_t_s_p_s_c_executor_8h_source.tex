\doxysection{TSPSCExecutor.\+h}
\hypertarget{_t_s_p_s_c_executor_8h_source}{}\label{_t_s_p_s_c_executor_8h_source}\index{Source/Utility/Concurrent/TSPSCExecutor.h@{Source/Utility/Concurrent/TSPSCExecutor.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ "{}Utility/Concurrent/TBlockableAtomicQuasiQueue.h"{}}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ "{}Utility/Concurrent/InitiallyPausedThread.h"{}}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ "{}Common/primitive\_type.h"{}}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ "{}Utility/TFunction.h"{}}}
\DoxyCodeLine{00007\ }
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ <type\_traits>}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ <thread>}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ <utility>}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ <atomic>}}
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#include\ <functional>}}
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#include\ <variant>}}
\DoxyCodeLine{00014\ }
\DoxyCodeLine{00015\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespaceph}{ph}}}
\DoxyCodeLine{00016\ \{}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00025\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Work>}
\DoxyCodeLine{00026\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor}{TSPSCExecutor}}\ final}
\DoxyCodeLine{00027\ \{}
\DoxyCodeLine{00028\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00031\ \ \ \ \ \textcolor{keyword}{inline}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_a9f6b5ce0addb84a3de6294984c9612a3}{TSPSCExecutor}}()}
\DoxyCodeLine{00032\ \ \ \ \ \ \ \ \ :\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor}{TSPSCExecutor}}(nullptr)}
\DoxyCodeLine{00033\ \ \ \ \ \{\}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00037\ \ \ \ \ \textcolor{keyword}{inline}\ \textcolor{keyword}{explicit}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_a6dfdf73fc1054ad47c06b9370768b58f}{TSPSCExecutor}}(std::function<\textcolor{keywordtype}{void}(\textcolor{keyword}{const}\ Work\&\ work)>\ workProcessor)}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ :\ m\_thread\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ()}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ ,\ m\_workloadQueue\ \ \ \ \ \ \ \ \ ()}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ ,\ m\_isTerminationRequested()}
\DoxyCodeLine{00041\ \ \ \ \ \ \ \ \ ,\ m\_isTerminated\ \ \ \ \ \ \ \ \ \ ()}
\DoxyCodeLine{00042\ \ \ \ \ \ \ \ \ ,\ m\_producerThreadId\ \ \ \ \ \ ()}
\DoxyCodeLine{00043\ \ \ \ \ \ \ \ \ ,\ m\_workProcessor\ \ \ \ \ \ \ \ \ (std::move(workProcessor))}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ ,\ m\_onConsumerStart\ \ \ \ \ \ \ ()}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ ,\ m\_onConsumerTerminate\ \ \ ()}
\DoxyCodeLine{00046\ \ \ \ \ \{}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ m\_thread\ =\ \mbox{\hyperlink{classph_1_1_initially_paused_thread}{InitiallyPausedThread}}(}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \ \ \ \ [\textcolor{keyword}{this}]()}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ asyncExecute();}
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00052\ \ \ \ \ \}}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00056\ \ \ \ \ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_a98a11651bfe5596cb1acb4d5125c45fb}{\string~TSPSCExecutor}}();}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00063\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_aff408fe833f82bb136083d0e62ff8592}{setWorkProcessor}}(std::function<\textcolor{keywordtype}{void}(\textcolor{keyword}{const}\ Work\&\ work)>\ workProcessor);}
\DoxyCodeLine{00064\ \ \ \ \ \textcolor{keywordtype}{void}\ setOnConsumerStart(std::function<\textcolor{keywordtype}{void}(\textcolor{keywordtype}{void})>\ onConsumerStart);}
\DoxyCodeLine{00065\ \ \ \ \ \textcolor{keywordtype}{void}\ setOnConsumerTerminate(std::function<\textcolor{keywordtype}{void}(\textcolor{keywordtype}{void})>\ onConsumerTerminate);}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00073\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_a0d4416821710b9c3c01b9798376a9f4e}{start}}();}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00081\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ DeducedWork>}
\DoxyCodeLine{00082\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_a348023aebd44b96af2d54e6aacda79a0}{addWork}}(DeducedWork\&\&\ work);}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{comment}{//\ TODO:\ bulk\ work\ addition}}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00090\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_a75b1bd75567ccb5adcd30bdd592b42ce}{waitAllWorks}}();}
\DoxyCodeLine{00091\ }
\DoxyCodeLine{00098\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_a52bee5c6bbc09397af7f73ef55969c93}{requestTermination}}();}
\DoxyCodeLine{00099\ }
\DoxyCodeLine{00106\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_ace6ac9244a6753e4a2da159fabd10d8d}{waitForTermination}}();}
\DoxyCodeLine{00107\ }
\DoxyCodeLine{00111\ \ \ \ \ std::thread::id\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_a7dd7b547217281c83d117359584375b1}{getId}}()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00116\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classph_1_1_t_s_p_s_c_executor_ac550b3718b38d56f5684e1ea546ee7d2}{hasStarted}}()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00122\ \ \ \ \ \textcolor{keywordtype}{void}\ asyncExecute();}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00127\ \ \ \ \ \textcolor{keywordtype}{void}\ asyncProcessWorks();}
\DoxyCodeLine{00128\ }
\DoxyCodeLine{00132\ \ \ \ \ \textcolor{keywordtype}{bool}\ isConsumerThread()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00133\ }
\DoxyCodeLine{00137\ \ \ \ \ \textcolor{keywordtype}{bool}\ isProducerThread()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00138\ }
\DoxyCodeLine{00141\ \ \ \ \ \textcolor{keywordtype}{void}\ terminate();}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00143\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00144\ \ \ \ \ \textcolor{comment}{//\ Callable\ type\ for\ internal\ usages.\ Warpping\ with\ a\ custom\ private\ type\ so\ we\ cannot\ mix\ }}
\DoxyCodeLine{00145\ \ \ \ \ \textcolor{comment}{//\ it\ with\ user\ types}}
\DoxyCodeLine{00146\ \ \ \ \ \textcolor{keyword}{struct\ }CustomCallable}
\DoxyCodeLine{00147\ \ \ \ \ \{}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classph_1_1function__detail_1_1_t_function}{TFunction}}<void(\textcolor{keywordtype}{void}),\ 0>\ callable;}
\DoxyCodeLine{00149\ \ \ \ \ \};}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00151\ \ \ \ \ \textcolor{comment}{//\ Possibly\ store\ both\ user-\/specified\ work\ and\ custom\ callables\ for\ internal\ usages}}
\DoxyCodeLine{00152\ \ \ \ \ \textcolor{keyword}{using\ }Workload\ =\ std::variant<}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ std::monostate,}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ Work,}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ CustomCallable>;}
\DoxyCodeLine{00156\ }
\DoxyCodeLine{00157\ \ \ \ \ \textcolor{comment}{//\ NOTE:\ moodycamel\ has\ faster\ SPSC\ queue,\ consider\ using\ it}}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \ \ \ \ InitiallyPausedThread\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_thread;}
\DoxyCodeLine{00160\ \ \ \ \ TBlockableAtomicQuasiQueue<Workload>\ \ m\_workloadQueue;}
\DoxyCodeLine{00161\ \ \ \ \ std::atomic\_flag\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_isTerminationRequested;}
\DoxyCodeLine{00162\ \ \ \ \ std::atomic\_flag\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_isTerminated;}
\DoxyCodeLine{00163\ \ \ \ \ std::thread::id\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_producerThreadId;}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{comment}{//\ Worker-\/thread\ only\ fields}}
\DoxyCodeLine{00166\ \ \ \ \ std::function<void(\textcolor{keyword}{const}\ Work\&\ work)>\ m\_workProcessor;}
\DoxyCodeLine{00167\ \ \ \ \ std::function<void(\textcolor{keywordtype}{void})>\ \ \ \ \ \ \ \ \ \ \ \ \ m\_onConsumerStart;}
\DoxyCodeLine{00168\ \ \ \ \ std::function<void(\textcolor{keywordtype}{void})>\ \ \ \ \ \ \ \ \ \ \ \ \ m\_onConsumerTerminate;}
\DoxyCodeLine{00169\ \};}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \}\textcolor{comment}{//\ end\ namespace\ ph}}
\DoxyCodeLine{00172\ }
\DoxyCodeLine{00173\ \textcolor{preprocessor}{\#include\ "{}Utility/Concurrent/TSPSCExecutor.ipp"{}}}

\end{DoxyCode}
