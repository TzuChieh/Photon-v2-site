\doxysection{TRadiance\+Evaluation\+Work.\+ipp}
\hypertarget{_t_radiance_evaluation_work_8ipp_source}{}\label{_t_radiance_evaluation_work_8ipp_source}\index{Source/Core/Renderer/PM/TRadianceEvaluationWork.ipp@{Source/Core/Renderer/PM/TRadianceEvaluationWork.ipp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ "{}Core/Renderer/PM/TRadianceEvaluationWork.h"{}}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ "{}Math/constant.h"{}}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ "{}Core/Intersectable/Primitive.h"{}}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ "{}Core/Intersectable/PrimitiveMetadata.h"{}}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ "{}Core/SurfaceBehavior/SurfaceBehavior.h"{}}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ "{}Core/SurfaceBehavior/SurfaceOptics.h"{}}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ "{}Core/SurfaceBehavior/BsdfEvalQuery.h"{}}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ "{}Core/SurfaceBehavior/BsdfSampleQuery.h"{}}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ "{}Core/SurfaceBehavior/BsdfPdfQuery.h"{}}}
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#include\ "{}Common/assertion.h"{}}}
\DoxyCodeLine{00013\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ <vector>}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespaceph}{ph}}}
\DoxyCodeLine{00017\ \{}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Photon>}
\DoxyCodeLine{00020\ \textcolor{keyword}{inline}\ TRadianceEvaluationWork<Photon>::TRadianceEvaluationWork(}
\DoxyCodeLine{00021\ \ \ \ \ \textcolor{keyword}{const}\ TPhotonMap<Photon>*\ photonMap,}
\DoxyCodeLine{00022\ \ \ \ \ \textcolor{keyword}{const}\ std::size\_t\ \ \ \ \ \ \ \ \ numPhotonPaths)\ :}
\DoxyCodeLine{00023\ \ \ \ \ m\_photonMap(photonMap),}
\DoxyCodeLine{00024\ \ \ \ \ m\_numPhotonPaths(numPhotonPaths)}
\DoxyCodeLine{00025\ \{}
\DoxyCodeLine{00026\ \ \ \ \ PH\_ASSERT(photonMap);}
\DoxyCodeLine{00027\ \ \ \ \ PH\_ASSERT\_GT(numPhotonPaths,\ 0);}
\DoxyCodeLine{00028\ \}}
\DoxyCodeLine{00029\ }
\DoxyCodeLine{00030\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Photon>}
\DoxyCodeLine{00031\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ TRadianceEvaluationWork<Photon>::doWork()}
\DoxyCodeLine{00032\ \{}
\DoxyCodeLine{00033\ \ \ \ \ \textcolor{comment}{/*for(std::size\_t\ i\ =\ 0;\ i\ <\ m\_numViewpoints;\ ++i)}}
\DoxyCodeLine{00034\ \textcolor{comment}{\ \ \ \ \{}}
\DoxyCodeLine{00035\ \textcolor{comment}{\ \ \ \ \ \ \ \ const\ Viewpoint\&\ viewpoint\ =\ m\_viewpoints[i];}}
\DoxyCodeLine{00036\ \textcolor{comment}{\ \ \ \ \ \ \ \ }}
\DoxyCodeLine{00037\ \textcolor{comment}{\ \ \ \ \ \ \ \ const\ Spectrum\&\ radiance\ =\ evaluateRadiance(}}
\DoxyCodeLine{00038\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ viewpoint.hit,}}
\DoxyCodeLine{00039\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ viewpoint.L,}}
\DoxyCodeLine{00040\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ viewpoint.radius);}}
\DoxyCodeLine{00041\ \textcolor{comment}{}}
\DoxyCodeLine{00042\ \textcolor{comment}{\ \ \ \ \ \ \ \ real\ filmXPx\ =\ viewpoint.filmNdcPos.x\ *\ static\_cast<real>(m\_film-\/>getActualResPx().x);}}
\DoxyCodeLine{00043\ \textcolor{comment}{\ \ \ \ \ \ \ \ real\ filmYPx\ =\ viewpoint.filmNdcPos.y\ *\ static\_cast<real>(m\_film-\/>getActualResPx().y);}}
\DoxyCodeLine{00044\ \textcolor{comment}{\ \ \ \ \ \ \ \ m\_film-\/>addSample(filmXPx,\ filmYPx,\ radiance);}}
\DoxyCodeLine{00045\ \textcolor{comment}{\ \ \ \ \}*/}}
\DoxyCodeLine{00046\ \}}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Photon>}
\DoxyCodeLine{00049\ \textcolor{keyword}{inline}\ math::Spectrum\ TRadianceEvaluationWork<Photon>::evaluateRadiance(}
\DoxyCodeLine{00050\ \ \ \ \ \textcolor{keyword}{const}\ SurfaceHit\&\ \ \ \ \ location,}
\DoxyCodeLine{00051\ \ \ \ \ \textcolor{keyword}{const}\ math::Vector3R\&\ excitant,}
\DoxyCodeLine{00052\ \ \ \ \ \textcolor{keyword}{const}\ real\ \ \ \ \ \ \ \ \ \ \ \ kernelRadius)}
\DoxyCodeLine{00053\ \{}
\DoxyCodeLine{00054\ \ \ \ \ \textcolor{comment}{/*static\_assert(}}
\DoxyCodeLine{00055\ \textcolor{comment}{\ \ \ \ \ \ \ \ Photon::has<EPhotonData::INCIDENT\_DIR>()\ \&\&}}
\DoxyCodeLine{00056\ \textcolor{comment}{\ \ \ \ \ \ \ \ Photon::has<EPhotonData::RADIANCE>()\ \ \ \ \ \&\&}}
\DoxyCodeLine{00057\ \textcolor{comment}{\ \ \ \ \ \ \ \ Photon::has<EPhotonData::THROUGHPUT>(),}}
\DoxyCodeLine{00058\ \textcolor{comment}{\ \ \ \ \ \ \ \ "{}provided\ Photon\ do\ not\ have\ sufficient\ data"{});}}
\DoxyCodeLine{00059\ \textcolor{comment}{}}
\DoxyCodeLine{00060\ \textcolor{comment}{\ \ \ \ const\ real\ reciKernelArea\ \ \ \ \ \ \ \ =\ 1.0\_r\ /\ (kernelRadius\ *\ kernelRadius\ *\ PH\_PI\_REAL);}}
\DoxyCodeLine{00061\ \textcolor{comment}{\ \ \ \ const\ real\ reciNumEmittedPhotons\ =\ 1.0\_r\ /\ static\_cast<real>(m\_numEmittedPhotons);}}
\DoxyCodeLine{00062\ \textcolor{comment}{}}
\DoxyCodeLine{00063\ \textcolor{comment}{\ \ \ \ m\_photonCache.clear();}}
\DoxyCodeLine{00064\ \textcolor{comment}{\ \ \ \ m\_photonMap-\/>findWithinRange(location.getPosition(),\ kernelRadius,\ m\_photonCache);*/}}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00066\ \ \ \ \ BsdfEvalQuery\ \ bsdfEval;}
\DoxyCodeLine{00067\ \ \ \ \ math::Spectrum\ radiance(0);}
\DoxyCodeLine{00068\ \ \ \ \ \textcolor{comment}{//for(const\ auto\&\ photon\ :\ m\_photonCache)}}
\DoxyCodeLine{00069\ \ \ \ \ \textcolor{comment}{//\{}}
\DoxyCodeLine{00070\ \ \ \ \ \textcolor{comment}{//\ \ const\ Vector3R\ V\ \ =\ excitant;}}
\DoxyCodeLine{00071\ \ \ \ \ \textcolor{comment}{//\ \ const\ Vector3R\ L\ \ =\ photon.getReference<EPhotonData::INCIDENT\_DIR>();}}
\DoxyCodeLine{00072\ \ \ \ \ \textcolor{comment}{//\ \ const\ Vector3R\ Ng\ =\ location.getGeometryNormal();}}
\DoxyCodeLine{00073\ \ \ \ \ \textcolor{comment}{//\ \ const\ Vector3R\ Ns\ =\ location.getShadingNormal();}}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \ \ \textcolor{comment}{//\ \ const\ PrimitiveMetadata*\ const\ metadata\ =\ location.getDetail().getPrimitive()-\/>getMetadata();}}
\DoxyCodeLine{00076\ \ \ \ \ \textcolor{comment}{//\ \ const\ SurfaceOptics*\ \ \ \ \ const\ optics\ =\ metadata-\/>getSurface().getOptics();}}
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00078\ \ \ \ \ \textcolor{comment}{//\ \ bsdfEval.inputs.set(location,\ L,\ V,\ ALL\_ELEMENTALS,\ ETransport::RADIANCE);}}
\DoxyCodeLine{00079\ \ \ \ \ \textcolor{comment}{//\ \ optics-\/>calcBsdf(bsdfEval);}}
\DoxyCodeLine{00080\ }
\DoxyCodeLine{00081\ \ \ \ \ \textcolor{comment}{//\ \ if(!bsdfEval.outputs.isGood())}}
\DoxyCodeLine{00082\ \ \ \ \ \textcolor{comment}{//\ \ \{}}
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ continue;}}
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{comment}{//\ \ \}}}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00086\ \ \ \ \ \textcolor{comment}{//\ \ Spectrum\ throughput(1.0\_r);}}
\DoxyCodeLine{00087\ \ \ \ \ \textcolor{comment}{//\ \ throughput.mulLocal(bsdfEval.outputs.bsdf);}}
\DoxyCodeLine{00088\ \ \ \ \ \textcolor{comment}{//\ \ //throughput.mulLocal(Ns.absDot(V)\ *\ Ng.absDot(L)\ /\ Ng.absDot(V)\ /\ Ns.absDot(L));}}
\DoxyCodeLine{00089\ \ \ \ \ \textcolor{comment}{//\ \ throughput.mulLocal(photon.getReference<EPhotonData::THROUGHPUT>());}}
\DoxyCodeLine{00090\ }
\DoxyCodeLine{00091\ \ \ \ \ \textcolor{comment}{//\ \ radiance.addLocal(throughput\ *\ photon.getReference<EPhotonData::RADIANCE>()\ *\ reciKernelArea\ *\ reciNumEmittedPhotons);}}
\DoxyCodeLine{00092\ \ \ \ \ \textcolor{comment}{//\}}}
\DoxyCodeLine{00093\ }
\DoxyCodeLine{00094\ \ \ \ \ \textcolor{comment}{/*for(std::size\_t\ i\ =\ 0;\ i\ <\ radiance.NUM\_VALUES;\ ++i)}}
\DoxyCodeLine{00095\ \textcolor{comment}{\ \ \ \ \{}}
\DoxyCodeLine{00096\ \textcolor{comment}{\ \ \ \ \ \ \ \ PH\_ASSERT\_MSG(!std::isinf(radiance[i])\ \&\&\ !std::isnan(radiance[i]),}}
\DoxyCodeLine{00097\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ std::to\_string(radiance[i]));}}
\DoxyCodeLine{00098\ \textcolor{comment}{\ \ \ \ \}*/}}
\DoxyCodeLine{00099\ }
\DoxyCodeLine{00100\ \ \ \ \ \textcolor{keywordflow}{return}\ radiance;}
\DoxyCodeLine{00101\ \}}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00103\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Photon>}
\DoxyCodeLine{00104\ \textcolor{keyword}{inline}\ \textcolor{keyword}{const}\ TPhotonMap<Photon>*\ TRadianceEvaluationWork<Photon>::getPhotonMap()\textcolor{keyword}{\ const}}
\DoxyCodeLine{00105\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00106\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_photonMap;}
\DoxyCodeLine{00107\ \}}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00109\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Photon>}
\DoxyCodeLine{00110\ \textcolor{keyword}{inline}\ \textcolor{keyword}{const}\ std::size\_t\ TRadianceEvaluationWork<Photon>::numPhotonPaths()\textcolor{keyword}{\ const}}
\DoxyCodeLine{00111\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00112\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_numPhotonPaths;}
\DoxyCodeLine{00113\ \}}
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00115\ \}\textcolor{comment}{//\ end\ namespace\ ph}}

\end{DoxyCode}
