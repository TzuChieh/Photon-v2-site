\doxysection{TRadiance\+Evaluation\+Work.\+ipp}
\hypertarget{_t_radiance_evaluation_work_8ipp_source}{}\label{_t_radiance_evaluation_work_8ipp_source}\index{Source/Core/Renderer/PM/TRadianceEvaluationWork.ipp@{Source/Core/Renderer/PM/TRadianceEvaluationWork.ipp}}
\mbox{\hyperlink{_t_radiance_evaluation_work_8ipp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_t_radiance_evaluation_work_8h}{Core/Renderer/PM/TRadianceEvaluationWork.h}}"{}}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{constant_8h}{Math/constant.h}}"{}}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_primitive_8h}{Core/Intersectable/Primitive.h}}"{}}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_primitive_metadata_8h}{Core/Intersectable/PrimitiveMetadata.h}}"{}}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_surface_behavior_8h}{Core/SurfaceBehavior/SurfaceBehavior.h}}"{}}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_surface_optics_8h}{Core/SurfaceBehavior/SurfaceOptics.h}}"{}}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_bsdf_eval_query_8h}{Core/SurfaceBehavior/BsdfEvalQuery.h}}"{}}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_bsdf_sample_query_8h}{Core/SurfaceBehavior/BsdfSampleQuery.h}}"{}}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_bsdf_pdf_query_8h}{Core/SurfaceBehavior/BsdfPdfQuery.h}}"{}}}
\DoxyCodeLine{00012\ }
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#include\ <Common/assertion.h>}}
\DoxyCodeLine{00014\ }
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ <vector>}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespaceph}{ph}}}
\DoxyCodeLine{00018\ \{}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Photon>}
\DoxyCodeLine{00021\ \textcolor{keyword}{inline}\ \mbox{\hyperlink{classph_1_1_t_radiance_evaluation_work_a37f6c94986f4800a0f2ac9e5b659e8a7}{TRadianceEvaluationWork<Photon>::TRadianceEvaluationWork}}(}
\DoxyCodeLine{00022\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classph_1_1math_1_1_t_indexed_point_kdtree}{TPhotonMap<Photon>}}*\ photonMap,}
\DoxyCodeLine{00023\ \ \ \ \ \textcolor{keyword}{const}\ std::size\_t\ \ \ \ \ \ \ \ \ numPhotonPaths)\ :}
\DoxyCodeLine{00024\ \ \ \ \ m\_photonMap(photonMap),}
\DoxyCodeLine{00025\ \ \ \ \ m\_numPhotonPaths(numPhotonPaths)}
\DoxyCodeLine{00026\ \{}
\DoxyCodeLine{00027\ \ \ \ \ PH\_ASSERT(photonMap);}
\DoxyCodeLine{00028\ \ \ \ \ PH\_ASSERT\_GT(numPhotonPaths,\ 0);}
\DoxyCodeLine{00029\ \}}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Photon>}
\DoxyCodeLine{00032\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classph_1_1_t_radiance_evaluation_work}{TRadianceEvaluationWork<Photon>::doWork}}()}
\DoxyCodeLine{00033\ \{}
\DoxyCodeLine{00034\ \ \ \ \ \textcolor{comment}{/*for(std::size\_t\ i\ =\ 0;\ i\ <\ m\_numViewpoints;\ ++i)}}
\DoxyCodeLine{00035\ \textcolor{comment}{\ \ \ \ \{}}
\DoxyCodeLine{00036\ \textcolor{comment}{\ \ \ \ \ \ \ \ const\ Viewpoint\&\ viewpoint\ =\ m\_viewpoints[i];}}
\DoxyCodeLine{00037\ \textcolor{comment}{\ \ \ \ \ \ \ \ }}
\DoxyCodeLine{00038\ \textcolor{comment}{\ \ \ \ \ \ \ \ const\ Spectrum\&\ radiance\ =\ evaluateRadiance(}}
\DoxyCodeLine{00039\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ viewpoint.hit,}}
\DoxyCodeLine{00040\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ viewpoint.L,}}
\DoxyCodeLine{00041\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ viewpoint.radius);}}
\DoxyCodeLine{00042\ \textcolor{comment}{}}
\DoxyCodeLine{00043\ \textcolor{comment}{\ \ \ \ \ \ \ \ real\ filmXPx\ =\ viewpoint.filmNdcPos.x\ *\ static\_cast<real>(m\_film-\/>getActualResPx().x);}}
\DoxyCodeLine{00044\ \textcolor{comment}{\ \ \ \ \ \ \ \ real\ filmYPx\ =\ viewpoint.filmNdcPos.y\ *\ static\_cast<real>(m\_film-\/>getActualResPx().y);}}
\DoxyCodeLine{00045\ \textcolor{comment}{\ \ \ \ \ \ \ \ m\_film-\/>addSample(filmXPx,\ filmYPx,\ radiance);}}
\DoxyCodeLine{00046\ \textcolor{comment}{\ \ \ \ \}*/}}
\DoxyCodeLine{00047\ \}}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00049\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Photon>}
\DoxyCodeLine{00050\ \textcolor{keyword}{inline}\ \mbox{\hyperlink{classph_1_1math_1_1_t_tristimulus_spectrum}{math::Spectrum}}\ \mbox{\hyperlink{classph_1_1_t_radiance_evaluation_work_a6f4f48b07f9f912426fa0f2a796a0152}{TRadianceEvaluationWork<Photon>::evaluateRadiance}}(}
\DoxyCodeLine{00051\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classph_1_1_surface_hit}{SurfaceHit}}\&\ \ \ \ \ location,}
\DoxyCodeLine{00052\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classph_1_1math_1_1_t_vector3}{math::Vector3R}}\&\ excitant,}
\DoxyCodeLine{00053\ \ \ \ \ \textcolor{keyword}{const}\ real\ \ \ \ \ \ \ \ \ \ \ \ kernelRadius)}
\DoxyCodeLine{00054\ \{}
\DoxyCodeLine{00055\ \ \ \ \ \textcolor{comment}{/*static\_assert(}}
\DoxyCodeLine{00056\ \textcolor{comment}{\ \ \ \ \ \ \ \ Photon::has<EPhotonData::INCIDENT\_DIR>()\ \&\&}}
\DoxyCodeLine{00057\ \textcolor{comment}{\ \ \ \ \ \ \ \ Photon::has<EPhotonData::RADIANCE>()\ \ \ \ \ \&\&}}
\DoxyCodeLine{00058\ \textcolor{comment}{\ \ \ \ \ \ \ \ Photon::has<EPhotonData::THROUGHPUT>(),}}
\DoxyCodeLine{00059\ \textcolor{comment}{\ \ \ \ \ \ \ \ "{}provided\ Photon\ do\ not\ have\ sufficient\ data"{});}}
\DoxyCodeLine{00060\ \textcolor{comment}{}}
\DoxyCodeLine{00061\ \textcolor{comment}{\ \ \ \ const\ real\ reciKernelArea\ \ \ \ \ \ \ \ =\ 1.0\_r\ /\ (kernelRadius\ *\ kernelRadius\ *\ PH\_PI\_REAL);}}
\DoxyCodeLine{00062\ \textcolor{comment}{\ \ \ \ const\ real\ reciNumEmittedPhotons\ =\ 1.0\_r\ /\ static\_cast<real>(m\_numEmittedPhotons);}}
\DoxyCodeLine{00063\ \textcolor{comment}{}}
\DoxyCodeLine{00064\ \textcolor{comment}{\ \ \ \ m\_photonCache.clear();}}
\DoxyCodeLine{00065\ \textcolor{comment}{\ \ \ \ m\_photonMap-\/>findWithinRange(location.getPosition(),\ kernelRadius,\ m\_photonCache);*/}}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ \ \ \mbox{\hyperlink{classph_1_1_bsdf_eval_query}{BsdfEvalQuery}}\ \ bsdfEval;}
\DoxyCodeLine{00068\ \ \ \ \ \mbox{\hyperlink{classph_1_1math_1_1_t_tristimulus_spectrum}{math::Spectrum}}\ radiance(0);}
\DoxyCodeLine{00069\ \ \ \ \ \textcolor{comment}{//for(const\ auto\&\ photon\ :\ m\_photonCache)}}
\DoxyCodeLine{00070\ \ \ \ \ \textcolor{comment}{//\{}}
\DoxyCodeLine{00071\ \ \ \ \ \textcolor{comment}{//\ \ const\ Vector3R\ V\ \ =\ excitant;}}
\DoxyCodeLine{00072\ \ \ \ \ \textcolor{comment}{//\ \ const\ Vector3R\ L\ \ =\ photon.getReference<EPhotonData::INCIDENT\_DIR>();}}
\DoxyCodeLine{00073\ \ \ \ \ \textcolor{comment}{//\ \ const\ Vector3R\ Ng\ =\ location.getGeometryNormal();}}
\DoxyCodeLine{00074\ \ \ \ \ \textcolor{comment}{//\ \ const\ Vector3R\ Ns\ =\ location.getShadingNormal();}}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00076\ \ \ \ \ \textcolor{comment}{//\ \ const\ PrimitiveMetadata*\ const\ metadata\ =\ location.getDetail().getPrimitive()-\/>getMetadata();}}
\DoxyCodeLine{00077\ \ \ \ \ \textcolor{comment}{//\ \ const\ SurfaceOptics*\ \ \ \ \ const\ optics\ =\ metadata-\/>getSurface().getOptics();}}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00079\ \ \ \ \ \textcolor{comment}{//\ \ bsdfEval.inputs.set(location,\ L,\ V,\ ALL\_ELEMENTALS,\ ETransport::RADIANCE);}}
\DoxyCodeLine{00080\ \ \ \ \ \textcolor{comment}{//\ \ optics-\/>calcBsdf(bsdfEval);}}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00082\ \ \ \ \ \textcolor{comment}{//\ \ if(!bsdfEval.outputs.isGood())}}
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{comment}{//\ \ \{}}
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ continue;}}
\DoxyCodeLine{00085\ \ \ \ \ \textcolor{comment}{//\ \ \}}}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00087\ \ \ \ \ \textcolor{comment}{//\ \ Spectrum\ throughput(1.0\_r);}}
\DoxyCodeLine{00088\ \ \ \ \ \textcolor{comment}{//\ \ throughput.mulLocal(bsdfEval.outputs.bsdf);}}
\DoxyCodeLine{00089\ \ \ \ \ \textcolor{comment}{//\ \ //throughput.mulLocal(Ns.absDot(V)\ *\ Ng.absDot(L)\ /\ Ng.absDot(V)\ /\ Ns.absDot(L));}}
\DoxyCodeLine{00090\ \ \ \ \ \textcolor{comment}{//\ \ throughput.mulLocal(photon.getReference<EPhotonData::THROUGHPUT>());}}
\DoxyCodeLine{00091\ }
\DoxyCodeLine{00092\ \ \ \ \ \textcolor{comment}{//\ \ radiance.addLocal(throughput\ *\ photon.getReference<EPhotonData::RADIANCE>()\ *\ reciKernelArea\ *\ reciNumEmittedPhotons);}}
\DoxyCodeLine{00093\ \ \ \ \ \textcolor{comment}{//\}}}
\DoxyCodeLine{00094\ }
\DoxyCodeLine{00095\ \ \ \ \ \textcolor{comment}{/*for(std::size\_t\ i\ =\ 0;\ i\ <\ radiance.NUM\_VALUES;\ ++i)}}
\DoxyCodeLine{00096\ \textcolor{comment}{\ \ \ \ \{}}
\DoxyCodeLine{00097\ \textcolor{comment}{\ \ \ \ \ \ \ \ PH\_ASSERT\_MSG(!std::isinf(radiance[i])\ \&\&\ !std::isnan(radiance[i]),}}
\DoxyCodeLine{00098\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ std::to\_string(radiance[i]));}}
\DoxyCodeLine{00099\ \textcolor{comment}{\ \ \ \ \}*/}}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00101\ \ \ \ \ \textcolor{keywordflow}{return}\ radiance;}
\DoxyCodeLine{00102\ \}}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00104\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Photon>}
\DoxyCodeLine{00105\ \textcolor{keyword}{inline}\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classph_1_1math_1_1_t_indexed_point_kdtree}{TPhotonMap<Photon>}}*\ \mbox{\hyperlink{classph_1_1_t_radiance_evaluation_work_a9cbd61e40456da50cd14c6e7907d5665}{TRadianceEvaluationWork<Photon>::getPhotonMap}}()\textcolor{keyword}{\ const}}
\DoxyCodeLine{00106\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_photonMap;}
\DoxyCodeLine{00108\ \}}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00110\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Photon>}
\DoxyCodeLine{00111\ \textcolor{keyword}{inline}\ \textcolor{keyword}{const}\ std::size\_t\ \mbox{\hyperlink{classph_1_1_t_radiance_evaluation_work_ab18ef8adc170b5436ec233a179356301}{TRadianceEvaluationWork<Photon>::numPhotonPaths}}()\textcolor{keyword}{\ const}}
\DoxyCodeLine{00112\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00113\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_numPhotonPaths;}
\DoxyCodeLine{00114\ \}}
\DoxyCodeLine{00115\ }
\DoxyCodeLine{00116\ \}\textcolor{comment}{//\ end\ namespace\ ph}}

\end{DoxyCode}
