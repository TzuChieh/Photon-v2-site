\doxysection{TDirect\+Light\+Estimator.\+ipp}
\hypertarget{_t_direct_light_estimator_8ipp_source}{}\label{_t_direct_light_estimator_8ipp_source}\index{Source/Core/LTABuildingBlock/TDirectLightEstimator.ipp@{Source/Core/LTABuildingBlock/TDirectLightEstimator.ipp}}
\mbox{\hyperlink{_t_direct_light_estimator_8ipp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_t_direct_light_estimator_8h}{Core/LTABuildingBlock/TDirectLightEstimator.h}}"{}}}
\DoxyCodeLine{00002\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_t_vector3_8h}{Math/TVector3.h}}"{}}}
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_scene_8h}{World/Scene.h}}"{}}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_direct_energy_sample_query_8h}{Core/Emitter/Query/DirectEnergySampleQuery.h}}"{}}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_surface_hit_8h}{Core/SurfaceHit.h}}"{}}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_primitive_metadata_8h}{Core/Intersectable/PrimitiveMetadata.h}}"{}}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_surface_behavior_8h}{Core/SurfaceBehavior/SurfaceBehavior.h}}"{}}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_hit_detail_8h}{Core/HitDetail.h}}"{}}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_primitive_8h}{Core/Intersectable/Primitive.h}}"{}}}
\DoxyCodeLine{00010\ }
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ <Common/assertion.h>}}
\DoxyCodeLine{00012\ }
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#include\ <algorithm>}}
\DoxyCodeLine{00014\ }
\DoxyCodeLine{00015\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespaceph}{ph}}}
\DoxyCodeLine{00016\ \{}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{keyword}{namespace}}
\DoxyCodeLine{00019\ \{}
\DoxyCodeLine{00020\ \ \ \ \ \textcolor{comment}{//\ FIXME:\ hardcoded\ number}}
\DoxyCodeLine{00021\ \ \ \ \ \textcolor{keyword}{constexpr}\ real\ DL\_RAY\_DELTA\_DIST\ =\ 0.0001\_r;}
\DoxyCodeLine{00022\ \}}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00024\ \textcolor{keyword}{template}<ES\textcolor{keywordtype}{id}ednessPolicy\ POLICY>}
\DoxyCodeLine{00025\ \textcolor{keyword}{inline}\ \mbox{\hyperlink{classph_1_1_t_direct_light_estimator_af7171a1deae58152387a84c60054d97d}{TDirectLightEstimator<POLICY>::TDirectLightEstimator}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classph_1_1_scene}{Scene}}*\ \textcolor{keyword}{const}\ scene)\ :\ }
\DoxyCodeLine{00026\ \ \ \ \ m\_scene(scene)}
\DoxyCodeLine{00027\ \{}
\DoxyCodeLine{00028\ \ \ \ \ PH\_ASSERT(scene);}
\DoxyCodeLine{00029\ \}}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \textcolor{keyword}{template}<ES\textcolor{keywordtype}{id}ednessPolicy\ POLICY>}
\DoxyCodeLine{00032\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classph_1_1_t_direct_light_estimator_a14c44518455d349c7f0a27005c49e59b}{TDirectLightEstimator<POLICY>::sample}}(}
\DoxyCodeLine{00033\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classph_1_1_surface_hit}{SurfaceHit}}\&\ \ \ \ \ targetPos,}
\DoxyCodeLine{00034\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classph_1_1_time}{Time}}\&\ \ \ \ \ \ \ \ \ \ \ time,}
\DoxyCodeLine{00035\ \ \ \ \ \mbox{\hyperlink{classph_1_1_sample_flow}{SampleFlow}}\&\ \ \ \ \ \ \ \ \ \ \ sampleFlow,}
\DoxyCodeLine{00036\ \ \ \ \ \mbox{\hyperlink{classph_1_1math_1_1_t_vector3}{math::Vector3R}}*\ \textcolor{keyword}{const}\ out\_L,}
\DoxyCodeLine{00037\ \ \ \ \ real*\ \textcolor{keyword}{const}\ \ \ \ \ \ \ \ \ \ \ out\_pdfW,}
\DoxyCodeLine{00038\ \ \ \ \ \mbox{\hyperlink{classph_1_1math_1_1_t_tristimulus_spectrum}{math::Spectrum}}*\ \textcolor{keyword}{const}\ out\_emittedRadiance)}
\DoxyCodeLine{00039\ \{}
\DoxyCodeLine{00040\ \ \ \ \ \textcolor{comment}{/*const\ PrimitiveMetadata*\ metadata\ =\ targetPos.getDetail().getPrimitive()-\/>getMetadata();}}
\DoxyCodeLine{00041\ \textcolor{comment}{\ \ \ \ const\ SurfaceOptics*\ optics\ =\ metadata-\/>getSurface().getOptics();}}
\DoxyCodeLine{00042\ \textcolor{comment}{\ \ \ \ if(optics-\/>getAllPhenomena().hasAny(\{ESurfacePhenomenon::DELTA\_REFLECTION,\ ESurfacePhenomenon::DELTA\_TRANSMISSION\}))}}
\DoxyCodeLine{00043\ \textcolor{comment}{\ \ \ \ \{}}
\DoxyCodeLine{00044\ \textcolor{comment}{\ \ \ \ \ \ \ \ return\ false;}}
\DoxyCodeLine{00045\ \textcolor{comment}{\ \ \ \ \}*/}}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00047\ \ \ \ \ \mbox{\hyperlink{classph_1_1_direct_energy_sample_query}{DirectEnergySampleQuery}}\ directLightSample;}
\DoxyCodeLine{00048\ \ \ \ \ directLightSample.\mbox{\hyperlink{classph_1_1_direct_energy_sample_query_a8404995417906e9cf77405675b80855b}{in}}.\mbox{\hyperlink{classph_1_1_direct_energy_sample_input_aa1bf628396d6292004ccbe35ac5751e6}{set}}(targetPos.\mbox{\hyperlink{classph_1_1_surface_hit_ab9436d2c3f6530722d402edb487f87f1}{getPosition}}());}
\DoxyCodeLine{00049\ \ \ \ \ m\_scene-\/>genDirectSample(directLightSample,\ sampleFlow);}
\DoxyCodeLine{00050\ \ \ \ \ \textcolor{keywordflow}{if}(directLightSample.\mbox{\hyperlink{classph_1_1_direct_energy_sample_query_afd932c008571b4d159a7bc33c4f22b04}{out}})}
\DoxyCodeLine{00051\ \ \ \ \ \{}
\DoxyCodeLine{00052\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classph_1_1math_1_1_t_vector3}{math::Vector3R}}\ toLightVec\ =\ directLightSample.\mbox{\hyperlink{classph_1_1_direct_energy_sample_query_afd932c008571b4d159a7bc33c4f22b04}{out}}.\mbox{\hyperlink{classph_1_1_direct_energy_sample_output_a67b07abf7d0925f877fa27359e51e453}{emitPos}}\ -\/\ directLightSample.\mbox{\hyperlink{classph_1_1_direct_energy_sample_query_a8404995417906e9cf77405675b80855b}{in}}.\mbox{\hyperlink{classph_1_1_direct_energy_sample_input_a8e1309a7ab7c486e69735101761b0d3c}{targetPos}};}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ sidedness\ agreement\ between\ real\ geometry\ and\ shading\ normal}}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(toLightVec.\mbox{\hyperlink{classph_1_1math_1_1_t_vector_n_base_acfa70203a3b892f2a545a344d5ab9e43}{lengthSquared}}()\ >\ \mbox{\hyperlink{namespaceph_1_1math_a3d95f12613138cf607ca4b4b0c04ea48}{math::squared}}(DL\_RAY\_DELTA\_DIST\ *\ 3)\ \&\&}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classph_1_1_sidedness_agreement}{SidednessAgreement}}(POLICY).isSidednessAgreed(targetPos,\ toLightVec))}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classph_1_1_ray}{Ray}}\ visRay(targetPos.\mbox{\hyperlink{classph_1_1_surface_hit_ab9436d2c3f6530722d402edb487f87f1}{getPosition}}(),\ toLightVec.\mbox{\hyperlink{classph_1_1math_1_1_t_vector_n_base_a83faa5cec9beeb81bb58af4a8b1d13b1}{normalize}}(),\ DL\_RAY\_DELTA\_DIST,\ toLightVec.\mbox{\hyperlink{classph_1_1math_1_1_t_vector_n_base_a3e6e348db5ae530ac1813402d5227fdf}{length}}()\ -\/\ DL\_RAY\_DELTA\_DIST\ *\ 2,\ time);}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(!m\_scene-\/>isOccluding(visRay))}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ PH\_ASSERT(out\_L\ \&\&\ out\_pdfW\ \&\&\ out\_emittedRadiance);}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ *out\_L\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ =\ visRay.\mbox{\hyperlink{classph_1_1_ray_a3f62b201c0015a647611282280130b52}{getDirection}}();}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ *out\_pdfW\ \ \ \ \ \ \ \ \ \ \ \ =\ directLightSample.\mbox{\hyperlink{classph_1_1_direct_energy_sample_query_afd932c008571b4d159a7bc33c4f22b04}{out}}.\mbox{\hyperlink{classph_1_1_direct_energy_sample_output_a12d06187bfa4d4b3b9b5ac6512e1480c}{pdfW}};}
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ *out\_emittedRadiance\ =\ directLightSample.\mbox{\hyperlink{classph_1_1_direct_energy_sample_query_afd932c008571b4d159a7bc33c4f22b04}{out}}.\mbox{\hyperlink{classph_1_1_direct_energy_sample_output_a9dd47b9c94ec51e1042b7ce750ad1440}{radianceLe}};}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00071\ \ \ \ \ \}}
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00073\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00074\ \}}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00076\ \textcolor{keyword}{template}<ES\textcolor{keywordtype}{id}ednessPolicy\ POLICY>}
\DoxyCodeLine{00077\ \textcolor{keyword}{inline}\ real\ \mbox{\hyperlink{classph_1_1_t_direct_light_estimator_a2957834000e7181cecd4d4a2ee4201c7}{TDirectLightEstimator<POLICY>::samplePdfWUnoccluded}}(}
\DoxyCodeLine{00078\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classph_1_1_surface_hit}{SurfaceHit}}\&\ X,}
\DoxyCodeLine{00079\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classph_1_1_surface_hit}{SurfaceHit}}\&\ Xe,}
\DoxyCodeLine{00080\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classph_1_1_time}{Time}}\&\ \ \ \ \ \ \ time)}
\DoxyCodeLine{00081\ \{}
\DoxyCodeLine{00082\ \ \ \ \ \textcolor{comment}{//\ FIXME:\ redundant\ pointers}}
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classph_1_1_primitive}{Primitive}}*\ \textcolor{keyword}{const}\ emissivePrimitive\ =\ Xe.\mbox{\hyperlink{classph_1_1_surface_hit_a796492b34ec40eb78da4b70c287b26d6}{getDetail}}().\mbox{\hyperlink{classph_1_1_hit_detail_a4227114111e5325f96dfdc83e8a98da3}{getPrimitive}}();}
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classph_1_1_emitter}{Emitter}}*\ \textcolor{keyword}{const}\ \ \ emitter\ \ \ \ \ \ \ \ \ \ \ =\ emissivePrimitive-\/>\mbox{\hyperlink{classph_1_1_primitive_a967b40614b286c46aed37e9cd81fec0e}{getMetadata}}()-\/>\mbox{\hyperlink{classph_1_1_primitive_metadata_aa1de761e2aba6c2e38782234fb84c729}{getSurface}}().\mbox{\hyperlink{classph_1_1_surface_behavior_afcd71b27cb7fb1042923227bcd29fbd7}{getEmitter}}();}
\DoxyCodeLine{00085\ \ \ \ \ PH\_ASSERT(emitter);}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00087\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_scene-\/>calcDirectPdfW(Xe,\ X.\mbox{\hyperlink{classph_1_1_surface_hit_ab9436d2c3f6530722d402edb487f87f1}{getPosition}}());}
\DoxyCodeLine{00088\ \}}
\DoxyCodeLine{00089\ }
\DoxyCodeLine{00090\ \}\textcolor{comment}{//\ end\ namespace\ ph}}

\end{DoxyCode}
